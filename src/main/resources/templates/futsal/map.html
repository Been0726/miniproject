<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">

<section layout:fragment="content">
    <div class="container my-4">
        <div class="row">
            <div class="col-md-6 mb-4">
                <div id="map" style="width: 100%; height: 400px; border-radius: 1rem; box-shadow: 0 0 10px rgba(0,0,0,0.1);"></div>
            </div>
            <div class="col-md-6">
                <div id="info-panel" class="card" style="display:none;">
                    <div class="card-body">
                        <h5 class="card-title" id="spot-name">í’‹ì‚´ì¥ ì´ë¦„</h5>
                        <p class="card-text" id="spot-time">ìš´ì˜ ì‹œê°„</p>
                        <p><a id="spot-home" href="#" target="_blank" class="btn btn-sm btn-outline-primary">í™ˆí˜ì´ì§€ ì´ë™</a></p>

                        <div id="spot-carousel" class="carousel slide mb-3" data-bs-ride="carousel">
                            <div class="carousel-inner">
                                <div class="carousel-item active">
                                    <img id="spot-img1" class="d-block w-100 rounded spot-img" alt="í’‹ì‚´ì¥ ì´ë¯¸ì§€1" style="display:none;">
                                </div>
                                <div class="carousel-item">
                                    <img id="spot-img2" class="d-block w-100 rounded spot-img" alt="í’‹ì‚´ì¥ ì´ë¯¸ì§€2" style="display:none;">
                                </div>
                                <div class="carousel-item">
                                    <img id="spot-img3" class="d-block w-100 rounded spot-img" alt="í’‹ì‚´ì¥ ì´ë¯¸ì§€3" style="display:none;">
                                </div>
                            </div>
                            <button class="carousel-control-prev" type="button" data-bs-target="#spot-carousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#spot-carousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            </button>
                        </div>

                        <div class="mb-3">
                            <label for="match-date" class="form-label">ë‚ ì§œ ì„ íƒ</label>
                            <input type="date" id="match-date" class="form-control" style="max-width: 200px;">
                        </div>

                        <div id="time-scroll" class="d-flex overflow-auto gap-2 p-2 border rounded bg-light" style="white-space: nowrap;"></div>

                        <div class="mt-2">
                            <span class="badge border border-primary text-primary">ì‹ ì²­ ê°€ëŠ¥ ì‹œê°„ëŒ€</span>
                            <span class="badge bg-info text-dark">ë‚´ê°€ ì‹ ì²­í•œ ì‹œê°„</span>
                            <span class="badge bg-success">ìƒëŒ€ ëŒ€ê¸° ì¤‘</span>
                            <span class="badge bg-secondary">ì˜ˆì•½ ë¶ˆê°€</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<div layout:fragment="script">
    <!-- âœ… autoload=falseë¡œ ì•ˆì „í•˜ê²Œ ë¶ˆëŸ¬ì˜¤ê¸° -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=49440d7f9d641096e3ec2593e1ee8b56&autoload=false"></script>

    <script>
        kakao.maps.load(function () {
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            let selectedSpotId = null;

            const map = new kakao.maps.Map(document.getElementById('map'), {
                center: new kakao.maps.LatLng(37.5665, 126.9780),
                level: 8
            });

            const markerImage = new kakao.maps.MarkerImage(
                'https://raw.githubusercontent.com/BinBinToure/Springboot-AWS-Webservice/refs/heads/master/marker.png',
                new kakao.maps.Size(36, 36),
                { offset: new kakao.maps.Point(18, 36) }
            );

            let openInfoWindow = null;

            fetch('/api/spots')
                .then(res => res.json())
                .then(data => {
                    data.forEach(spot => {
                        if (spot.latitude && spot.longitude) {
                            const position = new kakao.maps.LatLng(spot.latitude, spot.longitude);
                            const marker = new kakao.maps.Marker({ position, image: markerImage, map });

                            const infowindow = new kakao.maps.InfoWindow({
                                content: `<div style="padding:5px; font-size:13px;">${spot.name}</div>`
                            });

                            kakao.maps.event.addListener(marker, 'click', () => {
                                selectedSpotId = spot.id;
                                if (openInfoWindow) openInfoWindow.close();
                                infowindow.open(map, marker);
                                openInfoWindow = infowindow;

                                document.getElementById('info-panel').style.display = 'block';
                                document.getElementById('spot-name').textContent = spot.name;
                                document.getElementById('spot-time').textContent = spot.businessTime || 'ìš´ì˜ì‹œê°„ ì •ë³´ ì—†ìŒ';

                                const homepage = document.getElementById('spot-home');
                                homepage.href = spot.homepageUrl || '#';
                                homepage.textContent = spot.homepageUrl ? 'í™ˆí˜ì´ì§€ ì´ë™' : 'í™ˆí˜ì´ì§€ ì—†ìŒ';

                                for (let i = 1; i <= 3; i++) {
                                    const imgEl = document.getElementById(`spot-img${i}`);
                                    const url = spot[`img${i}Url`];
                                    if (url) {
                                        imgEl.src = url;
                                        imgEl.style.display = 'block';
                                    } else {
                                        imgEl.style.display = 'none';
                                    }
                                }

                                document.getElementById('match-date').onchange = renderTimeSlots;
                            });
                        }
                    });
                });

            function renderTimeSlots() {
                const container = document.getElementById("time-scroll");
                container.innerHTML = '';
                const selectedDate = document.getElementById('match-date').value;
                if (!selectedSpotId || !selectedDate) return;

                fetch(`/api/match-times?spotId=${selectedSpotId}&date=${selectedDate}`)
                    .then(res => res.json())
                    .then(slots => {
                        for (let hour = 0; hour < 24; hour += 2) {
                            const start = String(hour).padStart(2, '0') + ":00";
                            const endHour = (hour + 2) % 24;
                            const end = String(endHour).padStart(2, '0') + ":00";

                            const slot = slots.find(s => s.startTime === start && s.endTime === end);
                            const matched = slot ? slot.matched : false;
                            const requested = slot ? slot.requested : false;
                            const mine = slot ? slot.mine : false;

                            const form = document.createElement('form');
                            form.method = 'post';
                            form.action = '/match';
                            form.className = 'd-inline';

                            const formId = `match-form-${hour}`;
                            form.id = formId;

                            // âœ… ë²„íŠ¼ ìŠ¤íƒ€ì¼ ê²°ì •
                            let btnClass = 'btn-outline-primary'; // ê¸°ë³¸: íŒŒë€ í…Œë‘ë¦¬
                            let btnText = `${start} ~ ${end}`;
                            let disabled = '';

                            if (matched) {
                                btnClass = 'btn-secondary';
                                disabled = 'disabled';
                            } else if (mine) {
                                btnClass = 'btn-info';
                                disabled = 'disabled';
                            } else if (requested) {
                                btnClass = 'btn-success';
                            }

                            form.innerHTML = `
                                <input type="hidden" name="spotId" value="${selectedSpotId}" />
                                <input type="hidden" name="date" value="${selectedDate}" />
                                <input type="hidden" name="startTime" value="${start}" />
                                <input type="hidden" name="endTime" value="${end}" />
                                <input type="hidden" name="_csrf" value="${csrfToken}" />
                                <button type="button" class="btn btn-sm ${btnClass}"
                                    ${disabled}
                                    onclick="submitMatch('${formId}', '${selectedDate}', '${start}', '${end}')">
                                    ${btnText}
                                </button>
                            `;

                            container.appendChild(form);
                        }
                    });
            }

        });
    </script>

    <script>
        let pendingFormData = null; // âœ… ëª¨ë‹¬ì—ì„œ ì‚¬ìš©í•  formData ì €ì¥ìš©

        function submitMatch(formId, date, startTime, endTime) {
            const form = document.getElementById(formId);
            const formData = new FormData(form);
            pendingFormData = formData;

            // âœ… ëª¨ë‹¬ì— ì‹œê°„ ì •ë³´ë¥¼ ë„£ê³  í‘œì‹œ
            document.getElementById("confirmModalBody").innerText =
                `ì„ íƒí•˜ì‹  ë‚ ì§œëŠ” ${date}, ì‹œê°„ì€ ${startTime} ~ ${endTime} ì…ë‹ˆë‹¤.\nì´ëŒ€ë¡œ ì˜ˆì•½ì„ ì§„í–‰í• ê¹Œìš”?`;

            const confirmModal = new bootstrap.Modal(document.getElementById("confirmModal"));
            confirmModal.show();
        }

        // âœ… ëª¨ë‹¬ì˜ â€œì˜ˆ, ì‹ ì²­í•©ë‹ˆë‹¤â€ ë²„íŠ¼ â†’ ì‹¤ì œ AJAX ë§¤ì¹­ ìš”ì²­
        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("confirmMatchBtn").addEventListener("click", function () {
                if (!pendingFormData) return;

                fetch("/match", {
                    method: "POST",
                    body: pendingFormData
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text); });
                    }
                    return response.text();
                })
                .then(html => {
                    document.body.innerHTML = html;
                })
                .catch(error => {
                    const confirmModal = bootstrap.Modal.getInstance(document.getElementById("confirmModal"));
                    confirmModal.hide();

                    if (error.message.includes("í¬ì¸íŠ¸ê°€ ë¶€ì¡±")) {
                        const pointModal = new bootstrap.Modal(document.getElementById("pointModal"));
                        pointModal.show();
                    } else {
                        alert("ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”!");
                    }
                });
            });
        });
    </script>

    <!-- â±ï¸ ì˜ˆì•½ í™•ì¸ ëª¨ë‹¬ -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info">
                    <h5 class="modal-title" id="confirmModalLabel">â° ë§¤ì¹­ ì‹œê°„ í™•ì¸</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="confirmModalBody">
                    <!-- ì—¬ê¸°ì— ë‚ ì§œ/ì‹œê°„ì´ ë™ì ìœ¼ë¡œ ë“¤ì–´ê° -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-primary" id="confirmMatchBtn">ì˜ˆ, ì‹ ì²­í•©ë‹ˆë‹¤</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ’¸ í¬ì¸íŠ¸ ë¶€ì¡± ëª¨ë‹¬ (ê¸°ì¡´ ìœ ì§€) -->
    <div class="modal fade" id="pointModal" tabindex="-1" aria-labelledby="pointModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title" id="pointModalLabel">âš ï¸ í¬ì¸íŠ¸ ë¶€ì¡±</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤! ë§¤ì¹­ ì‹ ì²­ì€ ìµœì†Œ <strong>25,000P</strong>ê°€ í•„ìš”í•´ìš”.<br>
                    <a href="/point/charge" class="btn btn-primary mt-3">ğŸ’° ì¶©ì „í•˜ëŸ¬ ê°€ê¸°</a>
                </div>
            </div>
        </div>
    </div>


</div>

</html>
