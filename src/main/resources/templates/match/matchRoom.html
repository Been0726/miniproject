<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">
<head>
    <title>매칭 채팅방</title>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/layout1.css}" />
</head>

<body>
<div layout:fragment="content">
    <div class="container py-4">
        <!-- 🏷️ 제목 -->
        <div class="text-center mb-4">
            <h2 class="fw-bold" th:text="${chatRoomTitle} + ' 채팅방 🎮'"></h2>
        </div>

        <!-- 💬 채팅 박스 -->
        <div id="chat-box" class="border rounded p-3 mb-3 bg-white shadow-sm" style="height:400px; overflow:auto;">
            <div th:each="msg : ${messages}">
                <div th:if="${msg.sender == nickname}" class="d-flex justify-content-end mb-2">
                    <div class="bg-primary text-white rounded-3 px-3 py-2" style="max-width: 70%;">
                        <div class="fw-bold" th:text="${msg.sender}"></div>
                        <div th:text="${msg.content}" class="mb-1"></div>
                        <div class="text-end small text-white-50" th:text="'[' + ${#temporals.format(msg.regTime, 'HH:mm')} + ']'"></div>
                    </div>
                </div>

                <div th:if="${msg.sender != nickname}" class="d-flex justify-content-start mb-2">
                    <div class="bg-light text-dark rounded-3 px-3 py-2" style="max-width: 70%;">
                        <div class="fw-bold" th:text="${msg.sender}"></div>
                        <div th:text="${msg.content}" class="mb-1"></div>
                        <div class="text-end small text-muted" th:text="'[' + ${#temporals.format(msg.regTime, 'HH:mm')} + ']'"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 📝 입력창 -->
        <div class="input-group">
            <input type="text" id="message" class="form-control" placeholder="메시지 입력..." />
            <button class="btn btn-primary" onclick="sendMessage()">전송</button>
        </div>
    </div>

    <!-- 💻 실시간 JS -->
    <script th:inline="javascript">
        const slotId = [[${slotId}]];
        const sender = [[${nickname}]];
        const nickname = sender;

        const socket = new SockJS('/ws-chat');
        const stompClient = Stomp.over(socket);

        stompClient.connect({}, () => {
            stompClient.subscribe('/topic/chat/' + slotId, (msg) => {
                const body = JSON.parse(msg.body);
                const now = new Date();
                const time = now.toTimeString().substring(0, 5);

                const div = document.createElement('div');
                const bubble = document.createElement('div');

                if (body.sender === nickname) {
                    div.className = "d-flex justify-content-end mb-2";
                    bubble.className = "bg-primary text-white rounded-3 px-3 py-2";
                } else {
                    div.className = "d-flex justify-content-start mb-2";
                    bubble.className = "bg-light text-dark rounded-3 px-3 py-2";
                }

                bubble.innerHTML = `<div class="fw-bold">${body.sender}</div>
                                    <div>${body.content}</div>
                                    <div class="text-end small">${time}</div>`;
                div.appendChild(bubble);
                document.getElementById('chat-box').appendChild(div);

                const chatBox = document.getElementById('chat-box');
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        });

        function sendMessage() {
            const content = document.getElementById('message').value;
            if (!content) return;

            stompClient.send('/app/chat/' + slotId, {}, JSON.stringify({
                sender: sender,
                content: content,
                slotId: slotId
            }));

            document.getElementById('message').value = '';
        }

        window.onload = () => {
            const chatBox = document.getElementById('chat-box');
            chatBox.scrollTop = chatBox.scrollHeight;
        };
    </script>
</div>
</body>
</html>
