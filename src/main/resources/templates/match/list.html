<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">

<div layout:fragment="content" class="container mt-4">
    <h2>ë‚´ ë§¤ì¹˜ ë‚´ì—­</h2>

    <table class="table table-striped">
        <thead>
        <tr>
            <th>í’‹ì‚´ì¥</th>
            <th>ë‚ ì§œ</th>
            <th>ì‹œê°„</th>
            <th>ìƒëŒ€ë°© ë‹‰ë„¤ì„</th>
            <th>ìƒíƒœ</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="req : ${requests}">
            <td th:text="${req.matchSlot.spot.name}">í’‹ì‚´ì¥</td>
            <td th:text="${req.matchSlot.date}">ë‚ ì§œ</td>
            <td th:text="${req.matchSlot.startTime + ' ~ ' + req.matchSlot.endTime}">ì‹œê°„</td>
            <td>
                <span th:text="${req.opponent != null ? req.opponent.nickname : 'ì—†ìŒ'}">ìƒëŒ€ë°©</span>

                <th:block th:if="${req.opponent != null}">
                    <button type="button"
                            class="btn btn-sm btn-outline-info ms-2"
                            data-bs-toggle="modal"
                            data-bs-target="#ratingModal"
                            th:data-nickname="${req.opponent.nickname}"
                            onclick="loadRating(this)">
                        â­ í‰ì  ë³´ê¸°
                    </button>
                </th:block>
            </td>
            <td>
                <div class="d-inline-flex align-items-center gap-2">
                    <span th:if="${req.status != null and req.status.name() == 'CONFIRMED'}"
                          class="badge bg-success">ë§¤ì¹˜ í™•ì •</span>

                    <th:block th:if="${req.status.name() == 'CONFIRMED'}">
                        <a th:href="@{'/chat/slot/' + ${req.matchSlot.id}}"
                           class="btn btn-sm btn-outline-success">
                            ğŸ’¬ ì±„íŒ…í•˜ëŸ¬ ê°€ê¸°
                        </a>
                    </th:block>

                    <th:block th:if="${req.status.name() == 'CONFIRMED' and !ratedMatchIds.contains(req.id)}">
                        <button type="button"
                                class="btn btn-sm btn-outline-warning"
                                data-bs-toggle="modal"
                                data-bs-target="#rateModal"
                                th:data-match-id="${req.id}"
                                th:data-target-nickname="${req.opponent != null ? req.opponent.nickname : ''}">
                            â­ í‰ê°€í•˜ê¸°
                        </button>
                    </th:block>

                    <th:block th:if="${req.status.name() == 'CONFIRMED' and ratedMatchIds.contains(req.id)}">
                        <span class="badge bg-secondary">í‰ê°€ ì™„ë£Œ</span>
                    </th:block>

                    <th:block th:if="${req.status != null and req.status.name() == 'PENDING'}">
                        <span class="badge bg-warning text-dark">ë§¤ì¹˜ ëŒ€ê¸°ì¤‘</span>
                        <form th:action="@{/match/{id}/cancel(id=${req.id})}" method="post"
                              onsubmit="return confirm('ì •ë§ ì´ ë§¤ì¹­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')" style="display:inline;">
                            <input type="hidden" name="_method" value="delete" />
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <button type="submit" class="btn btn-sm btn-outline-danger">ì·¨ì†Œ</button>
                        </form>
                    </th:block>

                    <span th:if="${req.status == null}" class="badge bg-secondary">ìƒíƒœ ë¯¸ì§€ì •</span>
                </div>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const allRatings = /*[[${nicknameAllRatings}]]*/ {};

    document.getElementById('ratingModal').addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const nickname = button.getAttribute('data-nickname');
        const ratingList = document.getElementById('commentList');
        const avgRating = document.getElementById('averageScore');

        if (!nickname) {
            avgRating.textContent = 'ë‹‰ë„¤ì„ ì—†ìŒ';
            ratingList.innerHTML = '<p class="text-muted">ë‹‰ë„¤ì„ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>';
            return;
        }

        const ratings = allRatings[nickname] || [];

        if (ratings.length > 0) {
            const sum = ratings.reduce((acc, r) => acc + r.score, 0);
            avgRating.textContent = (sum / ratings.length).toFixed(1) + 'ì ';
        } else {
            avgRating.textContent = 'í‰ê°€ ì—†ìŒ';
        }

        ratingList.innerHTML = '';
        ratings.forEach(rating => {
            const card = document.createElement('div');
            card.className = 'border p-3 rounded shadow-sm bg-light';
            card.innerHTML =
                `<strong>â­ ${rating.score}ì </strong><br/>
                 <span class="text-muted small">by ${rating.raterNickname}</span><br/>
                 <p class="mb-0">${rating.comment}</p>`;
            ratingList.appendChild(card);
        });
    });
    /*]]>*/
</script>

</html>
